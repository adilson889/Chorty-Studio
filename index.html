<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chorty Studio Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #0f172a; touch-action: manipulation; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        textarea:focus { outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const CSS_MAP = {'exibicao':'display','posicao':'position','largura':'width','altura':'height','margem':'margin','preenchimento':'padding','cor de fundo':'background-color','cor do texto':'color','flexivel':'flex','direcao':'flex-direction','alinhar itens':'align-items','justificar conteudo':'justify-content','grade':'grid','colunas da grade':'grid-template-columns','tamanho da fonte':'font-size','borda':'border','raio da borda':'border-radius','gap':'gap','topo':'top','esquerda':'left','direita':'right','baixo':'bottom'};
        const CSS_VALS = {'flexivel':'flex','grade':'grid','coluna':'column','linha':'row','centro':'center','absoluta':'absolute','relativa':'relative','fixa':'fixed','negrito':'bold','oculto':'none','azul':'#3b82f6','vermelho':'#ef4444','verde':'#22c55e','branco':'#fff','preto':'#000'};
        const TERMINAL_CODE = `(function(){var t=document.createElement('div');t.style.cssText='position:fixed;bottom:0;left:0;width:100%;background:#1a1b26;color:#a9b1d6;font-family:monospace;z-index:9999;max-height:150px;overflow:auto;padding:8px;border-top:1px solid #333;font-size:12px;display:flex;flex-direction:column-reverse;';document.body.appendChild(t);function l(y,m){var d=document.createElement('div');d.style.borderBottom='1px solid #333';d.style.padding='2px 0';d.style.color=y==='e'?'#f7768e':'#73daca';d.textContent=(y==='e'?'✖ ':'➜ ')+m;t.insertBefore(d,t.firstChild)}var o=console.log;console.log=function(){var a=Array.from(arguments).map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' ');l('l',a);o.apply(console,arguments)};window.onerror=function(m){l('e',m)}})();`;
        const transpile = (code) => {
            const lines = code.split('\n');
            let html='',css='',js='',mode='html',defCss="body{margin:0;font-family:sans-serif;min-height:100vh;}*{box-sizing:border-box;}button{cursor:pointer;}";
            lines.forEach(line => {
                const t = line.trim();
                if(!t || t.startsWith('#')) return;
                if(t.startsWith('criar estilo')) { mode='css'; css+=t.includes('corpo')?'body{':'div{'; return; }
                if(t.startsWith('fechar estilo')) { mode='html'; css+='}'; return; }
                if(t.startsWith('criar comportamento')) { mode='js'; return; }
                if(t.startsWith('fechar comportamento')) { mode='html'; return; }
                if(mode==='html') {
                    if(t.startsWith('criar cabecalho')) html+='<header style="padding:1rem;background:#f8fafc;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">';
                    else if(t.startsWith('fechar cabecal')) html+='</header>';
                    else if(t.startsWith('criar corpo')) html+='<main style="padding:1.5rem;max-width:800px;margin:0 auto;">';
                    else if(t.startsWith('fechar corpo')) html+='</main>';
                    else if(t.startsWith('criar rodape')) html+='<footer style="padding:1rem;text-align:center;background:#f1f5f9;margin-top:auto;border-top:1px solid #e2e8f0;">';
                    else if(t.startsWith('fechar rodape')) html+='</footer>';
                    else if(t.startsWith('adicionar titulo')) html+=`<h1 style="font-size:2rem;font-weight:bold;margin-bottom:0.5em;">${t.match(/"([^"]+)"/)?.[1]||''}</h1>`;
                    else if(t.startsWith('adicionar subtitulo')) html+=`<h2 style="font-size:1.5rem;font-weight:600;margin-bottom:0.5em;">${t.match(/"([^"]+)"/)?.[1]||''}</h2>`;
                    else if(t.startsWith('adicionar paragrafo')) html+=`<p style="margin-bottom:1em;line-height:1.6;">${t.match(/"([^"]+)"/)?.[1]||''}</p>`;
                    else if(t.startsWith('adicionar botao')) { const txt=t.match(/"([^"]+)"/)?.[1]||'Btn'; const id=t.match(/com id "([^"]+)"/)?.[1]||''; html+=`<button id="${id}" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;">${txt}</button>`; }
                    else if(t.startsWith('adicionar campo')) { const l=t.match(/"([^"]+)"/)?.[1]||'Lbl'; const id=t.match(/com id "([^"]+)"/)?.[1]||''; html+=`<div style="margin-bottom:10px"><label style="display:block;margin-bottom:5px;font-weight:500">${l}</label><input id="${id}" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:6px;"></div>`; }
                }
                if(mode==='css') { const p=t.split(':'); if(p.length===2) css+=`${CSS_MAP[p[0].trim()]||p[0].trim()}:${CSS_VALS[p[1].trim()]||p[1].trim()};`; }
                if(mode==='js') {
                    let j=t.replace(/definir (.+) como (.+)/,'let $1=$2;').replace(/funcao (.+)/,'function $1(){').replace('fim funcao','}').replace(/imprimir (.+)/,'console.log($1);').replace(/mostrar alerta (.+)/,'alert($1);').replace(/se (.+) entao/,'if($1){').replace('senao','}else{').replace('fim se','}').replace(/buscar elemento "([^"]+)" adicionar evento "clique" com (.+)/,'setTimeout(()=>document.querySelector("$1")?.addEventListener("click",$2),500);');
                    if(j.includes(' mais ')) j=j.replace(/ mais /g,' + ');
                    js+=j+'\n';
                }
            });
            return { full: `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><style>${defCss}${css}</style></head><body>${html}<script>${TERMINAL_CODE}${js}<\/script></body></html>` };
        };
        const Icon = ({name}) => { React.useEffect(()=>{if(window.lucide)window.lucide.createIcons()}); return <i data-lucide={name} style={{width:20,height:20,display:'inline-block'}}></i> };
        const App = () => {
            const [code,setCode] = useState('# Edite aqui\ncriar pagina "App"\ncriar corpo\nadicionar titulo "Olá"\nfechar corpo');
            const [view,setView] = useState('editor');
            const [res,setRes] = useState('');
            const run = () => { setRes(transpile(code).full); setView('preview'); };
            const exp = () => { const z=new JSZip(); z.file("index.html",transpile(code).full); z.generateAsync({type:"blob"}).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download="app.zip";a.click()}) };
            const mic = () => { if(!window.webkitSpeechRecognition)return alert('Sem voz'); const r=new window.webkitSpeechRecognition(); r.lang='pt-BR'; r.onresult=e=>setCode(c=>c+'\n# Voz: '+e.results[0][0].transcript); r.start(); };
            return (
                <div className="flex flex-col h-screen bg-gray-900 text-white overflow-hidden">
                    <div className="h-16 border-b border-gray-800 flex items-center justify-between px-4 bg-gray-900 z-10">
                        <span className="font-bold text-xl text-blue-400">Chorty</span>
                        <div className="flex gap-2">
                           {view==='editor'?<><button onClick={mic} className="p-2 bg-gray-800 rounded-full"><Icon name="mic"/></button><button onClick={exp} className="p-2 bg-gray-800 rounded-full"><Icon name="download"/></button><button onClick={run} className="px-4 py-2 bg-green-600 rounded-full font-bold flex gap-2"><Icon name="play"/> Run</button></>:<button onClick={()=>setView('editor')} className="px-4 py-2 bg-gray-700 rounded-full font-bold flex gap-2"><Icon name="arrow-left"/> Voltar</button>}
                        </div>
                    </div>
                    <div className="flex-grow relative">{view==='editor'?<textarea value={code} onChange={e=>setCode(e.target.value)} className="w-full h-full bg-[#0f172a] text-[#e2e8f0] p-4 font-mono text-sm resize-none outline-none"/>:<iframe srcDoc={res} className="w-full h-full border-none bg-white"/>}</div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>


<script type="text/babel">
  // ... seu código existente ...

  // Modal de instalação PWA
  const InstallPromptModal = ({ onClose, onInstall }) => {
    return (
      <div className="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4 animate-in">
        <div className="bg-gray-900 w-full max-w-md rounded-2xl border border-gray-700 p-6 text-center relative shadow-2xl">
          <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl mx-auto mb-4 flex items-center justify-center shadow-lg">
            <span className="font-bold text-3xl text-white">Ch</span>
          </div>
          <h2 className="text-2xl font-bold text-white mb-2">Instalar Chorty Studio</h2>
          <p className="text-gray-300 mb-6">Instale o Chorto Studio em seu dispositivo para acesso rápido e funcionamento offline!</p>
          
          <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700 mb-6 text-left">
            <div className="flex items-start gap-3">
              <div className="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                <Icon name="zap" size={20} className="text-blue-400"/>
              </div>
              <div>
                <p className="text-white font-bold">Funciona Offline</p>
                <p className="text-gray-400 text-sm">Acesse mesmo sem internet</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3 mt-4">
              <div className="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                <Icon name="smartphone" size={20} className="text-green-400"/>
              </div>
              <div>
                <p className="text-white font-bold">App Nativo</p>
                <p className="text-gray-400 text-sm">Como um aplicativo instalado</p>
              </div>
            </div>
          </div>
          
          <div className="flex gap-3">
            <button 
              onClick={onClose} 
              className="flex-1 py-3 bg-gray-800 hover:bg-gray-700 rounded-xl text-white font-bold transition-colors"
            >
              Agora não
            </button>
            <button 
              onClick={onInstall} 
              className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl text-white font-bold transition-all active:scale-95"
            >
              Instalar Agora
            </button>
          </div>
          
          <p className="text-gray-500 text-xs mt-4">
            Toque em "Instalar Agora" e depois em "Adicionar à tela inicial"
          </p>
        </div>
      </div>
    );
  };

   const App = () => {
    // ... seu estado existente ...
    
    const [showInstallPrompt, setShowInstallPrompt] = useState(false);
    const [deferredPrompt, setDeferredPrompt] = useState(null);
    const [isFirstVisit, setIsFirstVisit] = useState(true);

    useEffect(() => {
      // Verificar se já está instalado
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('App já instalado');
        return;
      }

      // Registrar service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration);
          })
          .catch(error => {
            console.log('Falha ao registrar Service Worker:', error);
          });
      }

      // Verificar se é a primeira visita
      const hasSeenPrompt = localStorage.getItem('chorty_install_prompt_seen');
      
      if (!hasSeenPrompt) {
        // Primeira visita - mostrar modal imediatamente
        console.log('Primeira visita - mostrando modal de instalação');
        
        // Mostrar modal após pequeno delay para carregar a página
        const timer = setTimeout(() => {
          setShowInstallPrompt(true);
          // Marcar que já viu o prompt
          localStorage.setItem('chorty_install_prompt_seen', 'true');
        }, 1000); // Apenas 1 segundo para aparecer mais rápido
        
        return () => clearTimeout(timer);
      } else {
        // Não é primeira visita - usar lógica normal após 3 segundos
        console.log('Visita recorrente - modal após 3 segundos');
        const timer = setTimeout(() => {
          setShowInstallPrompt(true);
        }, 3000);
        
        return () => clearTimeout(timer);
      }

      // Ouvir evento de instalação
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        setDeferredPrompt(e);
        console.log('Evento beforeinstallprompt capturado');
      });

      // Limpar evento ao desmontar
      return () => {
        window.removeEventListener('beforeinstallprompt', () => {});
      };
    }, []);

    const handleInstall = async () => {
      if (deferredPrompt) {
        console.log('Solicitando instalação...');
        try {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            console.log('Usuário aceitou a instalação');
            // Limpar o prompt após instalação
            localStorage.removeItem('chorty_install_prompt_seen');
          } else {
            console.log('Usuário recusou a instalação');
          }
          
          // Independente da escolha, limpar o deferredPrompt
          setDeferredPrompt(null);
        } catch (error) {
          console.error('Erro durante instalação:', error);
        }
      } else {
        // Se não há deferredPrompt (navegadores mais antigos), mostrar instruções
        alert(
          'Para instalar o Chorty Studio:\n\n' +
          '1. Toque no menu do navegador (ícone ⋮ ou ⋯)\n' +
          '2. Procure a opção "Instalar app" ou "Adicionar à tela inicial"\n' +
          '3. Toque para instalar\n\n' +
          'Após instalação, o app aparecerá na sua tela inicial!'
        );
      }
      setShowInstallPrompt(false);
    };

    const handleClose = () => {
      setShowInstallPrompt(false);
    
         const closeCount = parseInt(localStorage.getItem('chorty_prompt_close_count') || '0');
      localStorage.setItem('chorty_prompt_close_count', (closeCount + 1).toString());
      
      
      if (closeCount >= 2) {
        localStorage.setItem('chorty_install_prompt_seen', 'never_show_again');
      }
    };

    

    return (
      <div className="flex flex-col h-screen w-screen overflow-hidden" style={{backgroundColor: th.bg, color: th.text}}>
        {}
        
        {showInstallPrompt && (
          <InstallPromptModal 
            onClose={handleClose}
            onInstall={handleInstall}
          />
        )}
      </div>
    );
  };

 
    </script>
    
</body>
</html>
